<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<link rel="stylesheet" href="css/main.css" />
	<link rel="stylesheet" href="http://malihu.github.io/custom-scrollbar/jquery.mCustomScrollbar.min.css" />
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
<!-- <button id="generateFiles">Generate Files</button> -->
<div id="container">
	<div id="data-controls-panel">
		<div id="language-controls">
			<input type="text" id="language-search">
		</div>
		<div id="localisation-controls">
			<label for="localisation-changed-only">Show changed only</label>
			<input type="checkbox" id="localisation-changed-only">
			<input type="text" id="localisation-search">
		</div>
	</div>
	<div id="worksheets"></div>
	<div id="data"></div>
</div>
<div id="login-form">
	<div id="sp-key">
		<input id="sp-key-value" type="text" placeholder="Enter spreadsheet key" value="1U23Aw8HXe82Kbn3AqLZB0ryUcGtVpIatoZQowzl0aho" />
		<button id="sp-key-ok">Ok</button>
	</div>	
</div>
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>
<script type="text/javascript" src="lib/underscore.js"></script>
<script src="http://malihu.github.io/custom-scrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		var worksheetsTemplate = $('#worksheet-template');
		var translationItemTemplate = $('#translation-item-template');
		var $data = $('#data');
		var $worksheets = $('#worksheets');
		$('#localisation-changed-only').click(function() {
			var value = $(this).is(':checked');
			var items = $data.find('.translation-item');
			if(!value) {
				items.fadeIn();
			} else {
				items.hide();
				$data.find('.translation-item.changed').fadeIn();
			}
		});
		$('#language-search').on('keyup', _.debounce(function() {
			var value = $(this).val();
			var items = $worksheets.find('.worksheet');
			if(!value) {
				items.show();
				return;
			}
			items.hide();
			items.filter(function(index, item) {
				return $(item).find('.worksheet-name').text().indexOf(value) > -1 ||
						$(item).find('.worksheet-lang').text().indexOf(value) > -1;

			}).fadeIn();
		}, 200));
		$('#localisation-search').on('keyup', _.debounce(function() {
			var value = $(this).val();
			var items = $data.find('.translation-item');
			if(!value) {
				items.show();
				return;
			}
			items.hide();
			items.filter(function(index, item) {
				return $(item).find('.translation-key').text().indexOf(value) > -1 ||
						$(item).find('.translation-value').text().indexOf(value) > -1 ||
						$(item).find('.translation-original').text().indexOf(value) > -1;

			}).fadeIn();			
		}, 200));
		$('#worksheets').on('click', '.worksheet', function() {
			var item = $(this);
			var url = item.find('.worksheet-url').html();
			var container = $('<div>').attr('id', 'translation-content');
			$.get('/worksheet', {url: url}, function(result) {
				result.forEach(function(item) {
					var translationItem = translationItemTemplate.tmpl(item);
					container.append(translationItem);
				});
				$data.html(container);
				container.mCustomScrollbar({
					theme: 'dark-3',
					scrollButtons: { enable: true },
					updateOnContentResize: true,
					advanced: { updateOnSelectorChange: "true" },
					scrollInertia: 0
				});
			});
		});
		$('#sp-key-ok').click(function() {
			var key = $('#sp-key-value').val();
			$.get('/worksheets', {key: key}, function(list) {
				var $worksheets = $('#worksheets');
				var $loginForm = $('#login-form');
				var $container = $('#container');
				$loginForm.fadeOut();
				$container.show();
				$worksheets.html('');
				list.forEach(function(item) {
					var $worksheet = worksheetsTemplate.tmpl(item);
					$worksheets.append($worksheet);
					$worksheet.fadeIn();
				});
				$('#worksheets').mCustomScrollbar({
					theme: 'dark-3',
					scrollButtons: { enable: true },
					updateOnContentResize: true,
					advanced: { updateOnSelectorChange: "true" },
					scrollInertia: 0
				});
			});
		});
		$('#data').on('click', '.translation-apply', function() {
			var $translationItemContainer = $(this).closest('.translation-item');
			var $textContainer = $translationItemContainer.find('.translation-value-text');
			// send update request
		});
		$('#data').on('click', '.translation-cancel', function() {
			var $translationItemContainer = $(this).closest('.translation-item');
			var $textContainer = $translationItemContainer.find('.translation-value-text');
			var defaultText = $textContainer.data('default');
			$translationItemContainer.toggleClass('changed', false);
			$textContainer.text(defaultText);
		});
		$('#data').on('keyup', '.translation-value-text', function() {
			var $textContainer = $(this);
			var $translationItemContainer = $textContainer.closest('.translation-item');
			var defaultValue = $textContainer.data('default');
			var isChanged = defaultValue !== $textContainer.text();
			$translationItemContainer.toggleClass('changed', isChanged);
		});
		$('#data').on('click', '.translation-item', function() {
			$(this).find('.translation-value > span').focus();
		});
	});
</script>
<script id="worksheet-template" type="text/x-jQuery-tmpl">
	<div class="worksheet">
		<div class="worksheet-name">${name}</div>
		<div class="worksheet-lang">${lang}</div>
		<div class="worksheet-url" style="display: none;">${link}</div>
	</div>
</script>
<script id="translation-item-template" type="text/x-jQuery-tmpl">
	<div class="translation-item">
		<div class="translation-buttons-section">
			<div class="translation-details"><i class="fa fa-database"></i></div>
			<div class="translation-actions">
				<div class="translation-apply"><i class="fa fa-check"></i></div>
				<div class="translation-cancel"><i class="fa fa-times"></i></div>
			</div>
		</div>
		<div class="translation-key" title="Localisation Key"><i class="fa fa-key"></i>&nbsp;${key}</div>
		<div class="translation-value" title="Translation"><i class="fa fa-refresh"></i>&nbsp;<span class="translation-value-text" contentEditable="true" data-default="${translation}">${translation}</span></div>
		<div class="translation-original" title="Original (English) value"><i class="fa fa-home"></i>&nbsp;${originalValue}</div>
	</div>
</script>
</body>
</html>